<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÄ‡∏™‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏†‡∏≤‡∏Ñ‡∏™‡∏ô‡∏≤‡∏°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        .main-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .navbar {
            flex-shrink: 0;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .map-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        #map {
            height: 100%;
            width: 100%;
            z-index: 1;
            cursor: crosshair;
        }
        .map-overlay {
            position: absolute;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        .map-overlay-top-right {
            top: 10px;
            right: 10px;
        }
        .map-overlay-bottom-right {
            bottom: 10px;
            right: 10px;
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 9999;
        }
        .modal-content {
            max-height: 90vh;
            overflow-y: auto;
            z-index: 10000;
        }
        .crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            pointer-events: none;
            color: #ef4444;
            font-size: 24px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        .distance-line {
            stroke: #3b82f6;
            stroke-width: 3;
            stroke-dasharray: 5,5;
            fill: none;
        }
        .marker-number {
            background: #3b82f6;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        #tableContainer {
            max-height: 400px;
            transition: max-height 0.3s ease;
        }
        .nav-button {
            transition: all 0.3s ease;
        }
        .nav-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .dashboard-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-active { background-color: #10b981; }
        .status-inactive { background-color: #ef4444; }
        .status-pending { background-color: #f59e0b; }
        
        /* Dashboard Full Screen */
        .dashboard-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #f0f9ff, #e0e7ff);
            z-index: 10000;
            overflow-y: auto;
        }
        
        /* Image Preview */
        .image-preview {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.9);
            z-index: 20000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .image-preview img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }
        .image-preview-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 20px;
            cursor: pointer;
        }
        
        /* Hover Image */
        .hover-image {
            position: absolute;
            z-index: 15000;
            max-width: 300px;
            max-height: 200px;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            pointer-events: none;
        }
        
        /* Real-time distance line */
        .temp-line {
            stroke: #ef4444;
            stroke-width: 2;
            stroke-dasharray: 3,3;
            fill: none;
            opacity: 0.8;
        }
        
        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.7);
            z-index: 15000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* SweetAlert2 custom z-index */
        .swal2-container {
            z-index: 20000 !important;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 font-sans">
    <div class="main-container">
        <!-- Navigation Bar -->
        <nav class="navbar px-4 py-3">
            <div class="flex items-center justify-between">
                <!-- Logo ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö -->
                <div class="flex items-center space-x-3">
                    <div class="text-2xl">üîå</div>
                    <h1 class="text-xl font-bold text-white">‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÄ‡∏™‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤</h1>
                </div>
                
                <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô -->
                <div id="currentProjectInfo" class="hidden flex items-center space-x-4 bg-white/20 rounded-lg px-4 py-2">
                    <div class="text-white">
                        <div class="text-sm opacity-90">‡∏ú‡∏π‡πâ‡∏™‡∏≥‡∏£‡∏ß‡∏à:</div>
                        <div id="currentSurveyorName" class="font-semibold">-</div>
                    </div>
                    <div class="text-white">
                        <div class="text-sm opacity-90">‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£:</div>
                        <div id="currentProjectName" class="font-semibold">-</div>
                    </div>
                    <div class="text-white">
                        <div class="text-sm opacity-90">‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà:</div>
                        <div id="currentPointDisplay" class="font-semibold text-yellow-300">1</div>
                    </div>
                </div>
                
                <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° -->
                <div class="flex items-center space-x-2">
                    <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà -->
                    <button id="newProjectBtn" class="nav-button bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium flex items-center space-x-2">
                        <span>üöÄ</span>
                        <span>‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</span>
                    </button>
                    
                    <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î -->
                    <button id="dashboardBtn" class="nav-button bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium flex items-center space-x-2">
                        <span>üìä</span>
                        <span>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</span>
                    </button>
                    
                    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£) -->
                    <button id="saveDataBtn" class="nav-button hidden bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg font-medium flex items-center space-x-2">
                        <span>üíæ</span>
                        <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>
                    </button>
                </div>
            </div>
        </nav>
        
        <!-- ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà -->
        <div class="map-container">
            <div id="map"></div>
            
            <!-- Crosshair -->
            <div id="crosshair" class="crosshair">üìç</div>
            
            <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (‡∏°‡∏∏‡∏°‡∏ö‡∏ô‡∏Ç‡∏ß‡∏≤) -->
            <div class="map-overlay map-overlay-top-right">
                <div class="text-xs space-y-1">
                    <div class="flex justify-between">
                        <span>‡∏£‡∏∞‡∏¢‡∏∞‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</span>
                        <span id="lastDistance" class="font-bold text-blue-600">0 ‡∏°.</span>
                    </div>
                    <div class="flex justify-between">
                        <span>‡∏£‡∏∞‡∏¢‡∏∞‡∏£‡∏ß‡∏°:</span>
                        <span id="totalDistance" class="font-bold text-green-600">0 ‡∏°.</span>
                    </div>
                    <div class="flex justify-between">
                        <span>‡∏à‡∏∏‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span>
                        <span id="totalPoints" class="font-bold text-purple-600">0</span>
                    </div>
                </div>
            </div>
            
            <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà (‡∏°‡∏∏‡∏°‡∏•‡πà‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤) -->
            <div class="map-overlay map-overlay-bottom-right">
                <div class="flex flex-col space-y-2">
                    <button id="currentLocationBtn" class="bg-blue-600 text-white p-2 rounded hover:bg-blue-700 transition-colors" title="‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô">
                        üìç
                    </button>
                    <button id="toggleMapBtn" class="bg-gray-600 text-white p-2 rounded hover:bg-gray-700 transition-colors" title="‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà">
                        üó∫Ô∏è
                    </button>
                    <button id="addPointBtn" class="bg-red-600 text-white p-2 rounded hover:bg-red-700 transition-colors" title="‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î">
                        ‚ûï
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà -->
    <div id="newProjectModal" class="fixed inset-0 modal-backdrop hidden items-center justify-center p-4">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-4 border-b bg-blue-600 text-white rounded-t-lg">
                <h3 class="text-lg font-semibold">üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</h3>
            </div>
            
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ú‡∏π‡πâ‡∏™‡∏≥‡∏£‡∏ß‡∏à</label>
                    <select id="surveyorSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏™‡∏≥‡∏£‡∏ß‡∏à...</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</label>
                    <input type="text" id="projectName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£...">
                </div>
            </div>
            
            <div class="p-4 border-t flex space-x-2">
                <button id="startSurveyBtn" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700">
                    ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏≥‡∏£‡∏ß‡∏à
                </button>
                <button id="cancelNewProjectBtn" class="flex-1 bg-gray-600 text-white py-2 px-4 rounded hover:bg-gray-700">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
            </div>
        </div>
    </div>

    <!-- Dashboard Full Screen -->
    <div id="dashboardFullscreen" class="dashboard-fullscreen hidden">
        <div class="p-6">
            <!-- Header -->
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-gray-800">üìä ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</h1>
                <button id="closeDashboardBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg flex items-center space-x-2">
                    <span>‚ùå</span>
                    <span>‡∏õ‡∏¥‡∏î</span>
                </button>
            </div>
            
            <!-- ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="dashboard-panel p-6">
                    <h3 class="text-xl font-semibold text-gray-700 mb-3">‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                    <p id="totalProjects" class="text-4xl font-bold text-blue-600">0</p>
                </div>
                <div class="dashboard-panel p-6">
                    <h3 class="text-xl font-semibold text-gray-700 mb-3">‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                    <p id="totalPointsAll" class="text-4xl font-bold text-green-600">0</p>
                </div>
                <div class="dashboard-panel p-6">
                    <h3 class="text-xl font-semibold text-gray-700 mb-3">‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏£‡∏ß‡∏°</h3>
                    <p id="totalDistanceAll" class="text-4xl font-bold text-purple-600">0 ‡∏°.</p>
                </div>
            </div>
            
            <!-- ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ -->
            <div class="dashboard-panel p-6 mb-8">
                <div class="flex flex-wrap gap-4 items-end">
                    <div class="flex-1 min-w-64">
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ú‡∏π‡πâ‡∏™‡∏≥‡∏£‡∏ß‡∏à</label>
                        <select id="filterSurveyor" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                        </select>
                    </div>
                    <div class="flex-1 min-w-64">
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</label>
                        <input type="text" id="searchInput" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£...">
                    </div>
                    <div class="flex space-x-3">
                        <button id="clearFilters" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-medium">
                            üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
            <div class="dashboard-panel overflow-hidden">
                <div class="p-4 bg-gray-50 border-b flex justify-between items-center">
                    <h3 class="text-xl font-semibold text-gray-800">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</h3>
                    <button id="toggleTableBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium">
                        üìã ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                    </button>
                </div>
                <div id="tableContainer" class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100 sticky top-0">
                            <tr>
                                <th class="px-6 py-4 text-left text-sm font-medium text-gray-500 uppercase">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                                <th class="px-6 py-4 text-left text-sm font-medium text-gray-500 uppercase">‡∏ú‡∏π‡πâ‡∏™‡∏≥‡∏£‡∏ß‡∏à</th>
                                <th class="px-6 py-4 text-left text-sm font-medium text-gray-500 uppercase">‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</th>
                                <th class="px-6 py-4 text-left text-sm font-medium text-gray-500 uppercase">‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏£‡∏ß‡∏° (‡πÄ‡∏°‡∏ï‡∏£)</th>
                                <th class="px-6 py-4 text-left text-sm font-medium text-gray-500 uppercase">‡∏†‡∏≤‡∏û‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</th>
                                <th class="px-6 py-4 text-left text-sm font-medium text-gray-500 uppercase">‡∏†‡∏≤‡∏û‡∏à‡∏∏‡∏î‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</th>
                                <th class="px-6 py-4 text-left text-sm font-medium text-gray-500 uppercase">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th class="px-6 py-4 text-left text-sm font-medium text-gray-500 uppercase">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î KML</th>
                            </tr>
                        </thead>
                        <tbody id="projectTableBody" class="divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∏‡∏î -->
    <div id="pointModal" class="fixed inset-0 modal-backdrop hidden items-center justify-center p-4">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-4 border-b bg-red-600 text-white rounded-t-lg">
                <h3 class="text-lg font-semibold">üìç ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà <span id="pointNumber">1</span></h3>
            </div>
            
            <div class="p-4 space-y-4 max-h-96 overflow-y-auto">
                <!-- ‡∏à‡∏∏‡∏î‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏∏‡∏î‡πÅ‡∏£‡∏Å) -->
                <div id="connectionPointSection">
                    <label class="block text-sm font-medium text-gray-700 mb-2">üì∑ ‡∏à‡∏∏‡∏î‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</label>
                    <input type="file" id="connectionImage" accept="image/*" class="w-full p-2 border border-gray-300 rounded">
                </div>
                
                <!-- ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏∏‡∏î‡πÅ‡∏£‡∏Å) -->
                <div id="documentSection">
                    <label class="block text-sm font-medium text-gray-700 mb-2">üìÑ ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö</label>
                    <input type="file" id="documentFile" accept="image/*,.pdf,.doc,.docx" class="w-full p-2 border border-gray-300 rounded">
                </div>
                
                <!-- ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏™‡∏≤ (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö) -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‚ö° ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏™‡∏≤ <span class="text-red-500">*</span></label>
                    <select id="poleType" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500" required>
                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏™‡∏≤...</option>
                    </select>
                </div>
                
                <!-- ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">üîß ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</label>
                    <select id="equipment" class="w-full p-2 border border-gray-300 rounded">
                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå...</option>
                    </select>
                </div>
                
                <!-- ‡∏´‡∏±‡∏ß‡πÄ‡∏™‡∏≤ -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">üîù ‡∏´‡∏±‡∏ß‡πÄ‡∏™‡∏≤</label>
                    <select id="poleHead" class="w-full p-2 border border-gray-300 rounded">
                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡πÄ‡∏™‡∏≤...</option>
                    </select>
                </div>
                
                <!-- ‡∏™‡∏≤‡∏¢‡∏¢‡∏∂‡∏î‡πÇ‡∏¢‡∏á&‡πÄ‡∏ó‡πÇ‡∏Ñ‡∏ô -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">üîó ‡∏™‡∏≤‡∏¢‡∏¢‡∏∂‡∏î‡πÇ‡∏¢‡∏á&‡πÄ‡∏ó‡πÇ‡∏Ñ‡∏ô</label>
                    <select id="wireSupport" class="w-full p-2 border border-gray-300 rounded">
                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏¢‡∏¢‡∏∂‡∏î‡πÇ‡∏¢‡∏á...</option>
                    </select>
                </div>
                
                <!-- ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">üì∏ ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö</label>
                    <input type="file" id="pointImage" accept="image/*" class="w-full p-2 border border-gray-300 rounded">
                </div>
                
                <!-- ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                    <textarea id="notes" class="w-full p-2 border border-gray-300 rounded" rows="3" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."></textarea>
                </div>
            </div>
            
            <div class="p-4 border-t flex space-x-2">
                <button id="addPointModalBtn" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700">
                    ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î
                </button>
                <button id="finishPointBtn" class="flex-1 bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700">
                    ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô
                </button>
                <button id="cancelPointBtn" class="flex-1 bg-gray-600 text-white py-2 px-4 rounded hover:bg-gray-700">
                    ‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
            </div>
        </div>
    </div>

    <script>
        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz3sc2q1SQAkeDN1MxHOClJLqPyuSwu7gEkZ_WkuI-FkrUb4tScLt43_TD4jIc1fqZUfw/exec';
        const SHEET_ID = '1gQR42JzTackvfuedJUW5Zm-s9N_sun0mFb8zdOPyeVg';
        const FOLDER_ID = '1AL8KrbctkMQRA_AgmVfMLZU4a76soBX_';
        
        let map;
        let currentSurveyor = '';
        let currentProject = '';
        let surveyPoints = [];
        let currentPointNumber = 1;
        let totalDistance = 0;
        let lastDistance = 0;
        let isMapSatellite = false;
        let polyline;
        let markers = [];
        let dropdownOptions = {};
        let allProjectData = [];
        let filteredProjectData = [];
        let isTableExpanded = false;
        let tempLine = null;
        let isProcessing = false;

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏≠‡∏õ
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        async function initializeApp() {
            try {
                await loadDropdownOptions();
                setupEventListeners();
                initializeMap();
            } catch (error) {
                console.error('Error initializing app:', error);
                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏≠‡∏õ‡πÑ‡∏î‡πâ', 'error');
            }
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å dropdown ‡∏à‡∏≤‡∏Å Google Sheet
        async function loadDropdownOptions() {
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getOptions`);
                const data = await response.json();
                
                if (data.success) {
                    dropdownOptions = data.options;
                    populateDropdowns();
                } else {
                    throw new Error(data.error || 'Failed to load options');
                }
            } catch (error) {
                console.error('Error loading dropdown options:', error);
                // ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ñ‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
                setDefaultOptions();
            }
        }

        function setDefaultOptions() {
            dropdownOptions = {
                surveyor: ['‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£ A', '‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£ B', '‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£ C'],
                poleType: ['‡πÄ‡∏™‡∏≤‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï', '‡πÄ‡∏™‡∏≤‡πÄ‡∏´‡∏•‡πá‡∏Å', '‡πÄ‡∏™‡∏≤‡πÑ‡∏°‡πâ'],
                equipment: ['‡∏´‡∏°‡πâ‡∏≠‡πÅ‡∏õ‡∏•‡∏á', '‡∏™‡∏ß‡∏¥‡∏ï‡∏ä‡πå', '‡πÑ‡∏°‡πà‡∏°‡∏µ'],
                poleHead: ['‡∏´‡∏±‡∏ß‡πÄ‡∏™‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥', '‡∏´‡∏±‡∏ß‡πÄ‡∏™‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏©'],
                wireSupport: ['‡∏°‡∏µ', '‡πÑ‡∏°‡πà‡∏°‡∏µ']
            };
            populateDropdowns();
        }

        function populateDropdowns() {
            // ‡∏ú‡∏π‡πâ‡∏™‡∏≥‡∏£‡∏ß‡∏à
            const surveyorSelect = document.getElementById('surveyorSelect');
            surveyorSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏™‡∏≥‡∏£‡∏ß‡∏à...</option>';
            dropdownOptions.surveyor?.forEach(option => {
                surveyorSelect.innerHTML += `<option value="${option}">${option}</option>`;
            });

            // ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏™‡∏≤
            const poleTypeSelect = document.getElementById('poleType');
            poleTypeSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏™‡∏≤...</option>';
            dropdownOptions.poleType?.forEach(option => {
                poleTypeSelect.innerHTML += `<option value="${option}">${option}</option>`;
            });

            // ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
            const equipmentSelect = document.getElementById('equipment');
            equipmentSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå...</option>';
            dropdownOptions.equipment?.forEach(option => {
                equipmentSelect.innerHTML += `<option value="${option}">${option}</option>`;
            });

            // ‡∏´‡∏±‡∏ß‡πÄ‡∏™‡∏≤
            const poleHeadSelect = document.getElementById('poleHead');
            poleHeadSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡πÄ‡∏™‡∏≤...</option>';
            dropdownOptions.poleHead?.forEach(option => {
                poleHeadSelect.innerHTML += `<option value="${option}">${option}</option>`;
            });

            // ‡∏™‡∏≤‡∏¢‡∏¢‡∏∂‡∏î‡πÇ‡∏¢‡∏á
            const wireSupportSelect = document.getElementById('wireSupport');
            wireSupportSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏¢‡∏¢‡∏∂‡∏î‡πÇ‡∏¢‡∏á...</option>';
            dropdownOptions.wireSupport?.forEach(option => {
                wireSupportSelect.innerHTML += `<option value="${option}">${option}</option>`;
            });
        }

        function setupEventListeners() {
            // ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ö‡∏ô‡∏≥‡∏ó‡∏≤‡∏á
            document.getElementById('newProjectBtn').addEventListener('click', showNewProjectModal);
            document.getElementById('dashboardBtn').addEventListener('click', showDashboardModal);
            document.getElementById('saveDataBtn').addEventListener('click', saveAllData);
            
            // ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
            document.getElementById('currentLocationBtn').addEventListener('click', getCurrentLocation);
            document.getElementById('toggleMapBtn').addEventListener('click', toggleMapView);
            document.getElementById('addPointBtn').addEventListener('click', confirmAddPoint);
            
            // Modal ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà
            document.getElementById('startSurveyBtn').addEventListener('click', startSurvey);
            document.getElementById('cancelNewProjectBtn').addEventListener('click', hideNewProjectModal);
            
            // Modal ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î
            document.getElementById('closeDashboardBtn').addEventListener('click', hideDashboardModal);
            
            // ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô Modal ‡∏à‡∏∏‡∏î
            document.getElementById('addPointModalBtn').addEventListener('click', addPointFromModal);
            document.getElementById('finishPointBtn').addEventListener('click', finishPoint);
            document.getElementById('cancelPointBtn').addEventListener('click', cancelPoint);
            
            // ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î
            document.getElementById('filterSurveyor').addEventListener('change', filterTable);
            document.getElementById('searchInput').addEventListener('input', filterTable);
            document.getElementById('clearFilters').addEventListener('click', clearFilters);
            document.getElementById('toggleTableBtn').addEventListener('click', toggleTable);
        }

        function initializeMap() {
            setTimeout(() => {
                try {
                    console.log('Initializing map...');
                    
                    if (typeof L === 'undefined') {
                        console.error('Leaflet not loaded');
                        Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ', 'error');
                        return;
                    }
                    
                    map = L.map('map', {
                        center: [13.7563, 100.5018],
                        zoom: 13,
                        zoomControl: true
                    });
                    
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap contributors',
                        maxZoom: 19
                    }).addTo(map);
                    
                    polyline = L.polyline([], {
                        color: '#3b82f6',
                        weight: 3,
                        dashArray: '5, 5'
                    }).addTo(map);
                    
                    // ‡πÄ‡∏™‡πâ‡∏ô‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå
                    tempLine = L.polyline([], {
                        color: '#ef4444',
                        weight: 2,
                        dashArray: '3, 3',
                        opacity: 0.8
                    }).addTo(map);
                    
                    map.on('click', function(e) {
                        if (currentSurveyor && currentProject && !isProcessing) {
                            confirmAddPointAtLocation(e.latlng);
                        }
                    });
                    
                    // ‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏≤‡∏™‡πå‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
                    map.on('mousemove', function(e) {
                        if (currentSurveyor && currentProject && surveyPoints.length > 0) {
                            updateTempLine(e.latlng);
                        }
                    });
                    
                    map.whenReady(() => {
                        console.log('Map ready');
                        getCurrentLocation();
                    });
                    
                    console.log('Map initialized successfully');
                } catch (error) {
                    console.error('Error initializing map:', error);
                    Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ: ' + error.message, 'error');
                }
            }, 300);
        }
        
        function updateTempLine(latlng) {
            if (surveyPoints.length > 0) {
                const lastPoint = surveyPoints[surveyPoints.length - 1];
                const tempDistance = calculateDistance(
                    lastPoint.lat, lastPoint.lng,
                    latlng.lat, latlng.lng
                );
                
                tempLine.setLatLngs([
                    [lastPoint.lat, lastPoint.lng],
                    [latlng.lat, latlng.lng]
                ]);
                
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
                document.getElementById('lastDistance').textContent = `${Math.round(tempDistance)} ‡∏°. (‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß)`;
            }
        }

        function showNewProjectModal() {
            document.getElementById('newProjectModal').classList.remove('hidden');
            document.getElementById('newProjectModal').classList.add('flex');
        }

        function hideNewProjectModal() {
            document.getElementById('newProjectModal').classList.add('hidden');
            document.getElementById('newProjectModal').classList.remove('flex');
        }

        async function showDashboardModal() {
            document.getElementById('dashboardFullscreen').classList.remove('hidden');
            await loadDashboardData();
        }

        function hideDashboardModal() {
            document.getElementById('dashboardFullscreen').classList.add('hidden');
        }

        function startSurvey() {
            const surveyor = document.getElementById('surveyorSelect').value;
            const project = document.getElementById('projectName').value;
            
            if (!surveyor || !project) {
                Swal.fire('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£', 'warning');
                return;
            }
            
            currentSurveyor = surveyor;
            currentProject = project;
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ö‡∏ô‡∏≥‡∏ó‡∏≤‡∏á
            document.getElementById('currentSurveyorName').textContent = surveyor;
            document.getElementById('currentProjectName').textContent = project;
            document.getElementById('currentProjectInfo').classList.remove('hidden');
            document.getElementById('saveDataBtn').classList.remove('hidden');
            
            hideNewProjectModal();
            
            Swal.fire({
                title: '‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß!',
                text: '‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß',
                icon: 'success',
                timer: 2000,
                showConfirmButton: false
            });
        }

        function getCurrentLocation() {
            if (navigator.geolocation) {
                Swal.fire({
                    title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á...',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        console.log('Location found:', lat, lng);
                        map.setView([lat, lng], 16);
                        Swal.close();
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                        Swal.close();
                        Swal.fire('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î GPS ‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á', 'error');
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    }
                );
            } else {
                Swal.fire('‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS', '‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á', 'error');
            }
        }

        function toggleMapView() {
            const mapContainer = map.getContainer();
            map.eachLayer((layer) => {
                if (layer instanceof L.TileLayer) {
                    map.removeLayer(layer);
                }
            });
            
            if (isMapSatellite) {
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(map);
                isMapSatellite = false;
            } else {
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: '¬© Esri'
                }).addTo(map);
                isMapSatellite = true;
            }
        }

        async function confirmAddPoint() {
            if (!currentSurveyor || !currentProject) {
                Swal.fire('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î', 'warning');
                return;
            }
            
            const result = await Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î',
                text: `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà ${currentPointNumber} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            });
            
            if (result.isConfirmed) {
                showPointModal();
            }
        }

        async function confirmAddPointAtLocation(latlng) {
            if (!currentSurveyor || !currentProject) {
                Swal.fire('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î', 'warning');
                return;
            }
            
            const result = await Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î',
                text: `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà ${currentPointNumber} ‡∏ó‡∏µ‡πà‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            });
            
            if (result.isConfirmed) {
                map.setView([latlng.lat, latlng.lng], map.getZoom());
                showPointModal();
            }
        }

        function showPointModal() {
            document.getElementById('pointNumber').textContent = currentPointNumber;
            
            const connectionSection = document.getElementById('connectionPointSection');
            const documentSection = document.getElementById('documentSection');
            
            if (currentPointNumber === 1) {
                connectionSection.style.display = 'block';
                documentSection.style.display = 'block';
            } else {
                connectionSection.style.display = 'none';
                documentSection.style.display = 'none';
            }
            
            resetModalForm();
            
            document.getElementById('pointModal').classList.remove('hidden');
            document.getElementById('pointModal').classList.add('flex');
        }

        function resetModalForm() {
            document.getElementById('connectionImage').value = '';
            document.getElementById('documentFile').value = '';
            document.getElementById('poleType').value = '';
            document.getElementById('equipment').value = '';
            document.getElementById('poleHead').value = '';
            document.getElementById('wireSupport').value = '';
            document.getElementById('pointImage').value = '';
            document.getElementById('notes').value = '';
        }

        function hidePointModal() {
            document.getElementById('pointModal').classList.add('hidden');
            document.getElementById('pointModal').classList.remove('flex');
        }

        async function addPointFromModal() {
            if (isProcessing) return;
            
            const poleType = document.getElementById('poleType').value;
            if (!poleType) {
                Swal.fire('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏™‡∏≤', 'warning');
                return;
            }
            
            isProcessing = true;
            
            // ‡πÅ‡∏™‡∏î‡∏á loading overlay
            showLoadingOverlay('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
            
            try {
                await saveCurrentPoint();
                currentPointNumber++;
                document.getElementById('currentPointDisplay').textContent = currentPointNumber;
                hidePointModal();
                hideLoadingOverlay();
                
                Swal.fire({
                    title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏à‡∏∏‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà',
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                });
            } catch (error) {
                hideLoadingOverlay();
                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
            } finally {
                isProcessing = false;
            }
        }
        
        function showLoadingOverlay(message) {
            const overlay = document.createElement('div');
            overlay.id = 'loadingOverlay';
            overlay.className = 'loading-overlay';
            overlay.innerHTML = `
                <div class="bg-white rounded-lg p-8 text-center">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                    <p class="text-lg font-medium text-gray-700">${message}</p>
                </div>
            `;
            document.body.appendChild(overlay);
        }
        
        function hideLoadingOverlay() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.remove();
            }
        }

        async function finishPoint() {
            const poleType = document.getElementById('poleType').value;
            if (!poleType) {
                Swal.fire('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏™‡∏≤', 'warning');
                return;
            }
            
            if (isProcessing) return;
            isProcessing = true;
            
            showLoadingOverlay('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
            
            try {
                await saveCurrentPoint();
                hidePointModal();
                hideLoadingOverlay();
                
                // ‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏£‡∏∞ ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
                if (polyline) {
                    polyline.setLatLngs([]);
                }
                if (tempLine) {
                    tempLine.setLatLngs([]);
                }
                
                showProjectCompletionOptions();
            } catch (error) {
                hideLoadingOverlay();
                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
            } finally {
                isProcessing = false;
            }
        }
        
        function showProjectCompletionOptions() {
            Swal.fire({
                title: '‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!',
                text: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß?',
                icon: 'success',
                showCancelButton: true,
                showDenyButton: true,
                confirmButtonText: 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                denyButtonText: 'üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                cancelButtonText: 'üìä ‡∏î‡∏π‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î',
                confirmButtonColor: '#10b981',
                denyButtonColor: '#ef4444',
                cancelButtonColor: '#6366f1'
            }).then((result) => {
                if (result.isConfirmed) {
                    saveAllData();
                } else if (result.isDenied) {
                    confirmClearData();
                } else if (result.dismiss === Swal.DismissReason.cancel) {
                    showDashboardModal();
                }
            });
        }
        
        function confirmClearData() {
            Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                text: '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                confirmButtonColor: '#ef4444'
            }).then((result) => {
                if (result.isConfirmed) {
                    resetSurveyData();
                    Swal.fire({
                        title: '‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß!',
                        text: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ñ‡∏π‡∏Å‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    });
                }
            });
        }

        function cancelPoint() {
            hidePointModal();
        }

        async function saveCurrentPoint() {
            const center = map.getCenter();
            const lat = center.lat;
            const lng = center.lng;
            
            const connectionImageUrl = await uploadFile(document.getElementById('connectionImage').files[0]);
            const documentUrl = await uploadFile(document.getElementById('documentFile').files[0]);
            const pointImageUrl = await uploadFile(document.getElementById('pointImage').files[0]);
            
            const pointData = {
                pointNumber: currentPointNumber,
                lat: lat,
                lng: lng,
                poleType: document.getElementById('poleType').value,
                equipment: document.getElementById('equipment').value,
                poleHead: document.getElementById('poleHead').value,
                wireSupport: document.getElementById('wireSupport').value,
                notes: document.getElementById('notes').value,
                connectionImageUrl: connectionImageUrl,
                documentUrl: documentUrl,
                pointImageUrl: pointImageUrl,
                timestamp: new Date().toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' })
            };
            
            surveyPoints.push(pointData);
            
            addMarkerToMap(lat, lng, currentPointNumber);
            calculateDistances();
            updateDistanceDisplay();
        }

        function addMarkerToMap(lat, lng, number) {
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á custom icon ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
            const customIcon = L.divIcon({
                className: 'marker-number',
                html: `<div class="marker-number">${number}</div>`,
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
            
            const marker = L.marker([lat, lng], { icon: customIcon }).addTo(map);
            marker.bindPopup(`‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà ${number}<br>‡∏û‡∏¥‡∏Å‡∏±‡∏î: ${lat.toFixed(6)}, ${lng.toFixed(6)}`);
            markers.push(marker);
            
            const points = surveyPoints.map(point => [point.lat, point.lng]);
            polyline.setLatLngs(points);
            
            // ‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
            tempLine.setLatLngs([]);
        }

        function calculateDistances() {
            if (surveyPoints.length < 2) {
                lastDistance = 0;
                totalDistance = 0;
                return;
            }
            
            const lastPoint = surveyPoints[surveyPoints.length - 1];
            const secondLastPoint = surveyPoints[surveyPoints.length - 2];
            
            lastDistance = calculateDistance(
                secondLastPoint.lat, secondLastPoint.lng,
                lastPoint.lat, lastPoint.lng
            );
            
            totalDistance = 0;
            for (let i = 1; i < surveyPoints.length; i++) {
                totalDistance += calculateDistance(
                    surveyPoints[i-1].lat, surveyPoints[i-1].lng,
                    surveyPoints[i].lat, surveyPoints[i].lng
                );
            }
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371000;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function updateDistanceDisplay() {
            document.getElementById('lastDistance').textContent = `${Math.round(lastDistance)} ‡∏°.`;
            document.getElementById('totalDistance').textContent = `${Math.round(totalDistance)} ‡∏°.`;
            document.getElementById('totalPoints').textContent = surveyPoints.length;
        }

        async function uploadFile(file) {
            if (!file) return '';
            
            try {
                const base64 = await fileToBase64(file);
                const params = new URLSearchParams({
                    action: 'uploadFile',
                    fileName: file.name,
                    fileData: base64,
                    folderId: FOLDER_ID,
                    surveyor: currentSurveyor
                });
                
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: params
                });
                
                const result = await response.json();
                return result.success ? result.url : '';
            } catch (error) {
                console.error('Error uploading file:', error);
                return '';
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        async function saveAllData() {
            if (surveyPoints.length === 0) {
                Swal.fire('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', 'warning');
                return;
            }
            
            Swal.fire({
                title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            try {
                const mapImageUrl = await captureMapScreenshot();
                
                for (const point of surveyPoints) {
                    const params = new URLSearchParams({
                        action: 'saveData',
                        surveyor: currentSurveyor,
                        project: currentProject,
                        pointNumber: point.pointNumber,
                        lat: point.lat,
                        lng: point.lng,
                        poleType: point.poleType,
                        equipment: point.equipment,
                        poleHead: point.poleHead,
                        wireSupport: point.wireSupport,
                        notes: point.notes,
                        timestamp: point.timestamp,
                        status: '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ú‡∏±‡∏á',
                        mapImageUrl: mapImageUrl,
                        connectionImageUrl: point.connectionImageUrl || '',
                        documentUrl: point.documentUrl || '',
                        pointImageUrl: point.pointImageUrl || ''
                    });
                    
                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        body: params
                    });
                    
                    const result = await response.json();
                    if (!result.success) {
                        throw new Error(result.error || 'Failed to save data');
                    }
                }
                
                Swal.fire({
                    title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                    text: `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${surveyPoints.length} ‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`,
                    icon: 'success',
                    timer: 3000,
                    showConfirmButton: false
                });
                resetSurveyData();
                
            } catch (error) {
                console.error('Error saving data:', error);
                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
            }
        }

        async function captureMapScreenshot() {
            try {
                const mapElement = document.getElementById('map');
                const canvas = await html2canvas(mapElement, {
                    useCORS: true,
                    allowTaint: true
                });
                
                const base64 = canvas.toDataURL('image/png').split(',')[1];
                const fileName = `map_${currentProject}_${Date.now()}.png`;
                
                const params = new URLSearchParams({
                    action: 'uploadFile',
                    fileName: fileName,
                    fileData: base64,
                    folderId: FOLDER_ID,
                    surveyor: currentSurveyor
                });
                
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: params
                });
                
                const result = await response.json();
                return result.success ? result.url : '';
            } catch (error) {
                console.error('Error capturing map screenshot:', error);
                return '';
            }
        }

        function resetSurveyData() {
            surveyPoints = [];
            currentPointNumber = 1;
            totalDistance = 0;
            lastDistance = 0;
            currentSurveyor = '';
            currentProject = '';
            
            // ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
            document.getElementById('currentProjectInfo').classList.add('hidden');
            document.getElementById('saveDataBtn').classList.add('hidden');
            document.getElementById('currentPointDisplay').textContent = '1';
            
            // ‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
            if (map) {
                markers.forEach(marker => map.removeLayer(marker));
                markers = [];
                if (polyline) {
                    polyline.setLatLngs([]);
                }
            }
            
            updateDistanceDisplay();
        }

        async function loadDashboardData() {
            try {
                Swal.fire({
                    title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                
                const response = await fetch(`${SCRIPT_URL}?action=getDashboardData`);
                const data = await response.json();
                
                if (data.success) {
                    allProjectData = data.data;
                    filteredProjectData = [...allProjectData];
                    updateDashboardDisplay(allProjectData);
                } else {
                    throw new Error(data.error || 'Failed to load dashboard data');
                }
                
                Swal.close();
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                Swal.close();
                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÑ‡∏î‡πâ', 'error');
            }
        }

        function updateDashboardDisplay(data) {
            const projects = [...new Set(data.map(row => row[1]).filter(p => p))];
            document.getElementById('totalProjects').textContent = projects.length;
            document.getElementById('totalPointsAll').textContent = data.length;
            
            const totalDistanceAll = data.reduce((sum, row, index) => {
                if (index > 0 && row[1] === data[index-1][1]) {
                    return sum + calculateDistance(
                        parseFloat(data[index-1][3]), parseFloat(data[index-1][4]),
                        parseFloat(row[3]), parseFloat(row[4])
                    );
                }
                return sum;
            }, 0);
            
            document.getElementById('totalDistanceAll').textContent = `${Math.round(totalDistanceAll)} ‡∏°.`;
            
            updateSurveyorFilter(data);
            updateProjectTable(data);
        }

        let currentPage = 1;
        const itemsPerPage = 20;
        let currentProjectSummary = {};
        
        function updateProjectTable(data) {
            filteredProjectData = data;
            
            const projectSummary = {};
            
            data.forEach(row => {
                const project = row[1];
                if (!projectSummary[project]) {
                    projectSummary[project] = {
                        surveyor: row[0],
                        distance: 0,
                        status: row[11] || '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ú‡∏±‡∏á',
                        mapImageUrl: row[12] || '',
                        connectionImageUrl: row[13] || ''
                    };
                }
                
                const projectData = data.filter(d => d[1] === project);
                let totalDistance = 0;
                for (let i = 1; i < projectData.length; i++) {
                    totalDistance += calculateDistance(
                        parseFloat(projectData[i-1][3]), parseFloat(projectData[i-1][4]),
                        parseFloat(projectData[i][3]), parseFloat(projectData[i][4])
                    );
                }
                projectSummary[project].distance = totalDistance;
            });
            
            currentProjectSummary = projectSummary;
            currentPage = 1;
            renderTablePage();
        }
        
        function renderTablePage() {
            const tbody = document.getElementById('projectTableBody');
            tbody.innerHTML = '';
            
            const projects = Object.entries(currentProjectSummary);
            const totalPages = Math.ceil(projects.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const currentProjects = projects.slice(startIndex, endIndex);
            
            currentProjects.forEach(([project, summary], index) => {
                const globalIndex = startIndex + index + 1;
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 text-sm">${globalIndex}</td>
                    <td class="px-6 py-4 text-sm">${summary.surveyor}</td>
                    <td class="px-6 py-4 text-sm font-medium">${project}</td>
                    <td class="px-6 py-4 text-sm">${Math.round(summary.distance)}</td>
                    <td class="px-6 py-4 text-sm">
                        ${summary.mapImageUrl ? `
                            <a href="javascript:void(0)" onclick="showImagePreview('${summary.mapImageUrl}')" 
                               onmouseover="showHoverImage(event, '${summary.mapImageUrl}')" 
                               onmouseout="hideHoverImage()" 
                               class="text-blue-600 hover:underline">üó∫Ô∏è ‡∏î‡∏π‡∏†‡∏≤‡∏û</a>
                        ` : '-'}
                    </td>
                    <td class="px-6 py-4 text-sm">
                        ${summary.connectionImageUrl ? `
                            <a href="javascript:void(0)" onclick="showImagePreview('${summary.connectionImageUrl}')" 
                               onmouseover="showHoverImage(event, '${summary.connectionImageUrl}')" 
                               onmouseout="hideHoverImage()" 
                               class="text-blue-600 hover:underline">üì∑ ‡∏î‡∏π‡∏†‡∏≤‡∏û</a>
                        ` : '-'}
                    </td>
                    <td class="px-6 py-4 text-sm">
                        <select class="text-sm p-2 border rounded-lg" onchange="updateProjectStatus('${project}', this.value)">
                            <option value="‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ú‡∏±‡∏á" ${summary.status === '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ú‡∏±‡∏á' ? 'selected' : ''}>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ú‡∏±‡∏á</option>
                            <option value="‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ú‡∏±‡∏á‡πÅ‡∏•‡πâ‡∏ß" ${summary.status === '‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ú‡∏±‡∏á‡πÅ‡∏•‡πâ‡∏ß' ? 'selected' : ''}>‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ú‡∏±‡∏á‡πÅ‡∏•‡πâ‡∏ß</option>
                        </select>
                    </td>
                    <td class="px-6 py-4 text-sm">
                        <button onclick="downloadKML('${project}')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-sm font-medium">
                            üì• KML
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            renderPagination(totalPages);
        }
        
        function renderPagination(totalPages) {
            const paginationContainer = document.getElementById('paginationContainer');
            if (!paginationContainer) {
                const container = document.createElement('div');
                container.id = 'paginationContainer';
                container.className = 'flex justify-center items-center space-x-2 p-4 bg-gray-50';
                document.getElementById('tableContainer').appendChild(container);
            }
            
            const pagination = document.getElementById('paginationContainer');
            pagination.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            // ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
            const prevBtn = document.createElement('button');
            prevBtn.className = `px-3 py-2 rounded-lg text-sm font-medium ${currentPage === 1 ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'bg-blue-600 text-white hover:bg-blue-700'}`;
            prevBtn.textContent = '‚Üê ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤';
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderTablePage();
                }
            };
            pagination.appendChild(prevBtn);
            
            // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏´‡∏ô‡πâ‡∏≤
            const pageInfo = document.createElement('span');
            pageInfo.className = 'px-4 py-2 text-sm text-gray-700';
            pageInfo.textContent = `‡∏´‡∏ô‡πâ‡∏≤ ${currentPage} ‡∏à‡∏≤‡∏Å ${totalPages}`;
            pagination.appendChild(pageInfo);
            
            // ‡∏õ‡∏∏‡πà‡∏°‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
            const nextBtn = document.createElement('button');
            nextBtn.className = `px-3 py-2 rounded-lg text-sm font-medium ${currentPage === totalPages ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'bg-blue-600 text-white hover:bg-blue-700'}`;
            nextBtn.textContent = '‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderTablePage();
                }
            };
            pagination.appendChild(nextBtn);
        }
        
        function showHoverImage(event, imageUrl) {
            const hoverImg = document.createElement('img');
            hoverImg.id = 'hoverImage';
            hoverImg.className = 'hover-image';
            hoverImg.src = imageUrl;
            hoverImg.style.left = (event.pageX + 10) + 'px';
            hoverImg.style.top = (event.pageY + 10) + 'px';
            document.body.appendChild(hoverImg);
        }
        
        function hideHoverImage() {
            const hoverImg = document.getElementById('hoverImage');
            if (hoverImg) {
                hoverImg.remove();
            }
        }
        
        function showImagePreview(imageUrl) {
            const preview = document.createElement('div');
            preview.className = 'image-preview';
            preview.innerHTML = `
                <button class="image-preview-close" onclick="closeImagePreview()">√ó</button>
                <img src="${imageUrl}" alt="‡∏†‡∏≤‡∏û‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á">
            `;
            document.body.appendChild(preview);
        }
        
        function closeImagePreview() {
            const preview = document.querySelector('.image-preview');
            if (preview) {
                preview.remove();
            }
        }

        function updateSurveyorFilter(data) {
            const filterSelect = document.getElementById('filterSurveyor');
            const currentValue = filterSelect.value;
            const surveyors = [...new Set(data.map(row => row[0]).filter(s => s))];
            
            filterSelect.innerHTML = '<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>';
            surveyors.forEach(surveyor => {
                const selected = surveyor === currentValue ? 'selected' : '';
                filterSelect.innerHTML += `<option value="${surveyor}" ${selected}>${surveyor}</option>`;
            });
        }

        function filterTable() {
            const surveyorFilter = document.getElementById('filterSurveyor').value;
            const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
            
            let filteredData = [...allProjectData];
            
            if (surveyorFilter) {
                filteredData = filteredData.filter(row => row[0] === surveyorFilter);
            }
            
            if (searchTerm) {
                filteredData = filteredData.filter(row => 
                    row[1] && row[1].toLowerCase().includes(searchTerm)
                );
            }
            
            updateProjectTable(filteredData);
        }

        function clearFilters() {
            document.getElementById('filterSurveyor').value = '';
            document.getElementById('searchInput').value = '';
            filterTable();
        }

        function toggleTable() {
            const tableContainer = document.getElementById('tableContainer');
            const toggleBtn = document.getElementById('toggleTableBtn');
            
            if (isTableExpanded) {
                tableContainer.style.maxHeight = '400px';
                toggleBtn.innerHTML = 'üìã ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏ï‡∏≤‡∏£‡∏≤‡∏á';
                isTableExpanded = false;
            } else {
                tableContainer.style.maxHeight = 'none';
                toggleBtn.innerHTML = 'üìã ‡∏¢‡πà‡∏≠‡∏ï‡∏≤‡∏£‡∏≤‡∏á';
                isTableExpanded = true;
            }
        }

        async function updateProjectStatus(project, status) {
            try {
                showLoadingOverlay('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞...');
                
                const params = new URLSearchParams({
                    action: 'updateStatus',
                    project: project,
                    status: status
                });
                
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: params
                });
                
                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error || 'Failed to update status');
                }
                
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£
                allProjectData.forEach(row => {
                    if (row[1] === project) {
                        row[11] = status;
                    }
                });
                
                hideLoadingOverlay();
                
                Swal.fire({
                    title: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                    text: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                });
                
                // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                await loadDashboardData();
                
            } catch (error) {
                console.error('Error updating status:', error);
                hideLoadingOverlay();
                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏î‡πâ', 'error');
            }
        }

        async function downloadKML(project) {
            try {
                showLoadingOverlay('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå KML...');
                
                const response = await fetch(`${SCRIPT_URL}?action=generateKML&project=${encodeURIComponent(project)}`);
                const data = await response.json();
                
                if (data.success) {
                    const blob = new Blob([data.kml], { type: 'application/vnd.google-earth.kml+xml' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${project}.kml`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    hideLoadingOverlay();
                    
                    Swal.fire({
                        title: '‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                        text: '‡πÑ‡∏ü‡∏•‡πå KML ‡∏ñ‡∏π‡∏Å‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    });
                } else {
                    throw new Error(data.error || 'Failed to generate KML');
                }
            } catch (error) {
                console.error('Error downloading KML:', error);
                hideLoadingOverlay();
                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå KML ‡πÑ‡∏î‡πâ', 'error');
            }
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98c8af07a5688945',t:'MTc2MDEyNjIxNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
