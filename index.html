<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mobile Map Fixed Version</title>

  <style id="mobile-ux-css">
    #map, .leaflet-container { touch-action: manipulation; }
    .map-overlay { pointer-events: none; }
    .map-overlay * { pointer-events: auto; }
    .leaflet-tooltip.measure-label {
      background: rgba(0,0,0,0.85);
      color: #fff;
      border: 0;
      border-radius: 8px;
      padding: 6px 10px;
      font-size: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
  </style>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>

<body>
  <div id="map" style="width:100%; height:100vh;"></div>

  <button class="current-location-btn" style="position:absolute; top:10px; left:10px; z-index:9999;">üìç ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</button>
  <div id="distance-text" style="position:absolute; top:10px; right:10px; background:rgba(255,255,255,0.9); padding:6px 10px; border-radius:8px; font-size:14px; font-weight:bold; z-index:9999;">0 ‡∏°.</div>

  <script>
    var map = L.map('map').setView([13.736717, 100.523186], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
    }).addTo(map);

    function getCurrentLocation() {
      if (!navigator.geolocation) {
        alert("‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á");
        return;
      }
      navigator.geolocation.getCurrentPosition(
        function (pos) {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          if (window.__gpsCenterGuard) {
            window.__gpsCenterGuard(lat, lng, 16);
          } else {
            map.setView([lat, lng], 16);
          }
          L.marker([lat, lng]).addTo(map).bindPopup("‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà").openPopup();
        },
        function (err) {
          console.error(err);
          alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ");
        }
      );
    }
  </script>

  <script id="mobile-ux-fixes">
  (function(){
    function attach(){
      if (!window.L || !window.map || typeof map.on !== 'function') return false;
      try { if (map.dragging && map.dragging.enable) map.dragging.enable(); } catch(e){}
      if (!window.__followUser){
        let _f=false;
        window.__followUser = { get: ()=>_f, set: v=>{ _f = !!v; } };
      } else {
        try { window.__followUser.set(false); } catch(e){}
      }
      ['setView','panTo','flyTo','fitBounds','flyToBounds'].forEach(fn=>{
        if (typeof map[fn] === 'function' && !map['__wrapped_'+fn]){
          const orig = map[fn].bind(map);
          map[fn] = function(){
            if (this.__forceNextCenter === true){
              this.__forceNextCenter = false;
              return orig.apply(this, arguments);
            }
            try{
              if (!window.__followUser.get()){
                return this;
              }
            }catch(e){}
            return orig.apply(this, arguments);
          };
          map['__wrapped_'+fn] = true;
        }
      });
      window.__gpsCenterGuard = function(lat,lng,zoom){
        if (window.__followUser.get()){
          map.setView([lat,lng], zoom != null ? zoom : map.getZoom());
        }
      };
      const btn = document.querySelector('.current-location-btn');
      if (btn && !btn.__hookedFollow){
        btn.__hookedFollow = true;
        btn.addEventListener('click', function(){
          try { window.__followUser.set(true); } catch(e){}
          map.__forceNextCenter = true;
          getCurrentLocation();
        });
      }
      const stopFollow = ()=>{ try { window.__followUser.set(false); } catch(e){} };
      map.on('dragstart zoomstart touchstart movestart', stopFollow);
      map.on('click', function(e){
        const { lat, lng } = e.latlng;
        L.marker([lat,lng]).addTo(map).bindPopup('‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà ' + Math.floor(Math.random()*100)).openPopup();
      });
      if (!map.__dragMeasureAttached){
        let startCenter=null, line=null, label=null;
        function fmt(m){ return m>=1000 ? (m/1000).toFixed(2)+' ‡∏Å‡∏°.' : Math.round(m)+' ‡∏°.'; }
        map.on('movestart', function(){
          startCenter = map.getCenter();
          if (line){ map.removeLayer(line); line=null; }
          if (label){ map.removeLayer(label); label=null; }
          line = L.polyline([startCenter, startCenter], {
            color:'#1976D2', weight:3, opacity:.95, dashArray:'10,8'
          }).addTo(map);
          label = L.tooltip({ permanent:true, direction:'center', className:'measure-label' })
                    .setLatLng(startCenter).setContent('0 ‡∏°.').addTo(map);
        });
        map.on('move', function(){
          if (!startCenter || !line) return;
          const cur = map.getCenter();
          line.setLatLngs([startCenter, cur]);
          const d = map.distance(startCenter, cur);
          const mid = L.latLng((startCenter.lat+cur.lat)/2, (startCenter.lng+cur.lng)/2);
          if (label) label.setLatLng(mid).setContent(fmt(d));
          const el = document.getElementById('distance-text');
          if (el) el.textContent = fmt(d);
        });
        function cleanup(){
          if (line){ map.removeLayer(line); line=null; }
          if (label){ map.removeLayer(label); label=null; }
          startCenter=null;
        }
        map.on('moveend', cleanup);
        map.on('zoomstart', cleanup);
        document.addEventListener('visibilitychange', ()=>{ if (document.hidden) cleanup(); });
        map.__dragMeasureAttached = true;
      }
      return true;
    }
    let tries=0;
    (function wait(){ if (!attach() && tries++ < 100) setTimeout(wait, 250); })();
  })();
  </script>
</body>
</html>
